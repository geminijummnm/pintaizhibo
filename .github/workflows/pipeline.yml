name: M3U Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-sources:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests  # ç¡®ä¿å®‰è£…requestsåº“

    - name: Generate URL files
      env:
        BASE_URL: ${{ secrets.BASE_URL }}
        JSON_URL: ${{ secrets.JSON_URL }}
      run: |
        mkdir -p sources/url
        python scripts/generate_sources.py
        echo "ç”Ÿæˆçš„URLæ–‡ä»¶ï¼š"
        tree sources/url/

    - uses: actions/upload-artifact@v4
      with:
        name: url-files
        path: sources/url/

  build-m3u:
    needs: generate-sources
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download URL files
      uses: actions/download-artifact@v4
      with:
        name: url-files
        path: sources/url

    - name: Setup Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq tree  # å®‰è£…ä¾èµ–å·¥å…·

    - name: Process M3U
      run: |
        # åˆå§‹åŒ–ç›®å½•
        mkdir -p ../m3u  # åœ¨æ ¹ç›®å½•åˆ›å»ºm3uæ–‡ä»¶å¤¹
        
        # è®¾ç½®ç»å¯¹è·¯å¾„
        WORKSPACE="/home/runner/work/pintaizhibo"
        REPO_DIR="${WORKSPACE}/pintaizhibo"
        M3U_DIR="${WORKSPACE}/m3u"
        URL_DIR="${REPO_DIR}/sources/url"

        echo "ğŸ› ï¸ è·¯å¾„éªŒè¯"
        echo "å·¥ä½œåŒºæ ¹ç›®å½•: ${WORKSPACE}"
        echo "ä»“åº“ç›®å½•: ${REPO_DIR}"
        echo "M3Uè¾“å‡ºç›®å½•: ${M3U_DIR}"
        echo "URLæ–‡ä»¶ç›®å½•: ${URL_DIR}"
        echo "ç›®å½•ç»“æ„:"
        tree -L 3 "${WORKSPACE}"

        # è¿è¡Œå¤„ç†è„šæœ¬
        chmod +x ${REPO_DIR}/scripts/process_m3u.sh
        ${REPO_DIR}/scripts/process_m3u.sh

        # ç»“æœéªŒè¯
        echo "=== ç”Ÿæˆçš„M3Uæ–‡ä»¶ ==="
        tree "${M3U_DIR}"

    - uses: actions/upload-artifact@v4
      with:
        name: m3u-files
        path: ../m3u/  # ä¸Šä¼ æ ¹ç›®å½•ä¸‹çš„m3uæ–‡ä»¶å¤¹
