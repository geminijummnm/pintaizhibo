name: M3U Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-sources:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4  # æ£€å‡ºä»“åº“

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        cache: 'pip'  # å¯ç”¨ç¼“å­˜åŠ é€Ÿ

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests  # æ˜¾å¼å®‰è£…ä¾èµ–

    - name: Generate URL Files
      env:
        BASE_URL: ${{ secrets.BASE_URL }}
        JSON_URL: ${{ secrets.JSON_URL }}
      run: |
        # åˆ›å»ºç›®å½•å¹¶ç”Ÿæˆæ–‡ä»¶
        mkdir -p sources/url
        echo "ğŸ› ï¸ å¼€å§‹ç”ŸæˆURLæ–‡ä»¶..."
        python scripts/generate_sources.py

        # éªŒè¯ç”Ÿæˆç»“æœ
        echo "=== ç”Ÿæˆçš„URLæ–‡ä»¶ ==="
        tree sources/url/

    - uses: actions/upload-artifact@v4
      with:
        name: url-files
        path: sources/url/

  build-m3u:
    needs: generate-sources  # ä¾èµ–å‰åºä»»åŠ¡
    runs-on: ubuntu-latest
    env:
      WORKSPACE: "/home/runner/work/pintaizhibo"  # å…¨å±€è·¯å¾„å®šä¹‰
    steps:
    - uses: actions/checkout@v4

    - name: Download URL Files
      uses: actions/download-artifact@v4
      with:
        name: url-files
        path: sources/url  # ä¸‹è½½åˆ°æ­£ç¡®ä½ç½®

    - name: Setup Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq tree  # å®‰è£…å¤„ç†å·¥å…·

    - name: Process M3U Files
      run: |
        # å®šä¹‰ç»å¯¹è·¯å¾„
        REPO_DIR="${WORKSPACE}/pintaizhibo"
        M3U_DIR="${WORKSPACE}/m3u"
        URL_DIR="${REPO_DIR}/sources/url"

        # å¼ºåˆ¶åˆ›å»ºç›®å½•å¹¶éªŒè¯æƒé™
        mkdir -p "${M3U_DIR}"
        echo "âœ… ç›®å½•æƒé™éªŒè¯ï¼š"
        ls -ld "${M3U_DIR}"
        touch "${M3U_DIR}/testfile" && rm "${M3U_DIR}/testfile"

        # è¿è¡Œå¤„ç†è„šæœ¬
        echo "ğŸƒ æ‰§è¡Œå¤„ç†è„šæœ¬..."
        chmod +x "${REPO_DIR}/scripts/process_m3u.sh"
        "${REPO_DIR}/scripts/process_m3u.sh"

        # æœ€ç»ˆéªŒè¯
        echo "=== ç”Ÿæˆçš„M3Uæ–‡ä»¶ ==="
        tree -sh "${M3U_DIR}"

    - name: Commit and Push M3U Files
      run: |
        # é…ç½®Gitèº«ä»½
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # å°†ç”Ÿæˆçš„m3uæ–‡ä»¶ç§»åŠ¨åˆ°ä»“åº“ç›®å½•
        REPO_DIR="/home/runner/work/pintaizhibo/pintaizhibo"
        mkdir -p "${REPO_DIR}/m3u"
        cp -r /home/runner/work/pintaizhibo/m3u/* "${REPO_DIR}/m3u/"

        # æäº¤æ›´æ”¹
        cd "${REPO_DIR}"
        git add m3u/
        git commit -m "Auto-Update M3U Files [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨å†…ç½®Token
