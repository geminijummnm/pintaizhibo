name: M3U Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-sources:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Generate URL files
      env:
        BASE_URL: ${{ secrets.BASE_URL }}
        JSON_URL: ${{ secrets.JSON_URL }}
      run: |
        mkdir -p sources/url
        python scripts/generate_sources.py
        echo "ç”Ÿæˆçš„URLæ–‡ä»¶ï¼š"
        tree sources/url/

    - uses: actions/upload-artifact@v4
      with:
        name: url-files
        path: sources/url/

  build-m3u:
    needs: generate-sources
    runs-on: ubuntu-latest
    env:
      WORKSPACE: "/home/runner/work/pintaizhibo"  # å£°æ˜å…¨å±€å˜é‡
    steps:
    - uses: actions/checkout@v4
    
    - name: Download URL files
      uses: actions/download-artifact@v4
      with:
        name: url-files
        path: sources/url

    - name: Setup Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq tree

    - name: Process M3U
      run: |
        # å®šä¹‰ç»å¯¹è·¯å¾„
        M3U_DIR="${WORKSPACE}/m3u"
        REPO_DIR="${WORKSPACE}/pintaizhibo"
        URL_DIR="${REPO_DIR}/sources/url"

        # å¼ºåˆ¶åˆ›å»ºå¹¶éªŒè¯ç›®å½•
        mkdir -p "${M3U_DIR}"
        echo "ğŸ› ï¸ ç›®å½•æƒé™éªŒè¯"
        ls -ld "${M3U_DIR}"
        touch "${M3U_DIR}/testfile" && rm "${M3U_DIR}/testfile"

        # è¿è¡Œå¤„ç†è„šæœ¬
        chmod +x "${REPO_DIR}/scripts/process_m3u.sh"
        "${REPO_DIR}/scripts/process_m3u.sh"

        # ç»“æœéªŒè¯ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        echo "=== ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ ==="
        ls -l "${M3U_DIR}"
        echo "=== æ–‡ä»¶æ•°é‡ ==="
        find "${M3U_DIR}" -name "*.m3u" | wc -l

    - name: Upload M3U Files
      uses: actions/upload-artifact@v4
      with:
        name: m3u-output
        path: ${{ env.WORKSPACE }}/m3u  # ä½¿ç”¨ç»å¯¹è·¯å¾„
